name: Publish Homebrew Cask

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., 0.6.1)"
        required: true
        type: string

jobs:
  update-and-publish-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      VERSION: ${{ github.event.inputs.version }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download release assets
        run: |
          BASE_URL="https://github.com/${{ github.repository }}/releases/download/v${VERSION}"
          ASSET_INTEL="par-fractal-macos-x86_64.zip"
          ASSET_ARM="par-fractal-macos-aarch64.zip"

          echo "Downloading Intel asset: $ASSET_INTEL"
          ### FIX: Added -f (--fail) so the script stops if the file is missing (404)
          curl -f -L -o "$ASSET_INTEL" "$BASE_URL/$ASSET_INTEL"

          echo "Downloading ARM asset: $ASSET_ARM"
          ### FIX: Added -f here as well
          curl -f -L -o "$ASSET_ARM" "$BASE_URL/$ASSET_ARM"

      - name: Calculate SHA256
        id: sha256_calc
        run: |
          SHA256_INTEL=$(shasum -a 256 "par-fractal-macos-x86_64.zip" | awk '{print $1}')
          SHA256_ARM=$(shasum -a 256 "par-fractal-macos-aarch64.zip" | awk '{print $1}')

          echo "sha256_intel=$SHA256_INTEL" >> "$GITHUB_OUTPUT"
          echo "sha256_arm=$SHA256_ARM" >> "$GITHUB_OUTPUT"

      - name: Update Cask file
        env:
          CASK_FILE: homebrew/Casks/par-fractal.rb
          # VERSION is inherited from Job env, strictly not needed here
          SHA_INTEL: ${{ steps.sha256_calc.outputs.sha256_intel }}
          SHA_ARM: ${{ steps.sha256_calc.outputs.sha256_arm }}
        run: |
          python <<'PY'
          import os
          import re
          from pathlib import Path

          path = Path(os.environ["CASK_FILE"])
          version = os.environ["VERSION"]
          sha_intel = os.environ["SHA_INTEL"]
          sha_arm = os.environ["SHA_ARM"]
          
          # Ensure file exists before reading
          if not path.exists():
              raise FileNotFoundError(f"Cask file not found at: {path}")
          
          text = path.read_text()

          def apply(pattern, repl):
              global text
              new_text, count = re.subn(pattern, repl, text, count=1)
              if count != 1:
                  raise SystemExit(f"Failed to replace pattern: {pattern}")
              return new_text

          text = apply(r'version\s+"[^"]+"', f'version "{version}"')
          text = apply(r'(sha256\s+arm:\s+)"[^"]+"', r'\1"' + sha_arm + '"')
          text = apply(r'(\s+intel:\s+)"[^"]+"', r'\1"' + sha_intel + '"')

          path.write_text(text)
          print(text)
          PY

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and Push to Source Repo
        run: |
          git pull --rebase origin main
          git add homebrew/Casks/par-fractal.rb
          git commit -m "Update par-fractal cask to v${VERSION}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Sync Homebrew tap repository
        env:
          TAP_REPO: paulrobello/homebrew-par-fractal
          TAP_BRANCH: main
          TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          if [ -z "$TAP_TOKEN" ]; then
            echo "HOMEBREW_TAP_TOKEN secret must be set to push to $TAP_REPO" >&2
            exit 1
          fi

          TAP_DIR="$(mktemp -d)"
          # FIX: Use --depth 1 to speed up clone if history isn't needed
          git clone --depth 1 "https://${TAP_TOKEN}@github.com/${TAP_REPO}.git" "$TAP_DIR"

          # FIX: Ensure destination folder exists, otherwise cp fails if tap is flat
          mkdir -p "$TAP_DIR/Casks"
          cp homebrew/Casks/par-fractal.rb "$TAP_DIR/Casks/par-fractal.rb"

          # FIX: Use a subshell (...) instead of pushd/popd for cleaner error handling
          (
            cd "$TAP_DIR" || exit 1
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
          
            # Since we did a fresh clone, pull is rarely needed, but rebase is safe
            git pull --rebase origin "$TAP_BRANCH"
          
            git add Casks/par-fractal.rb
            if git diff --cached --quiet; then
              echo "Tap already up-to-date; skipping commit."
            else
              git commit -m "Update par-fractal cask to v${VERSION}"
              git push origin "$TAP_BRANCH"
            fi
          )